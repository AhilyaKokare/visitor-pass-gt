<div class="container mt-4">
  <h3>Security Dashboard - Today's Visitors</h3>

  <!-- Search Section -->
  <div class="card mb-4">
    <div class="card-header fw-bold">Search for a Visitor Pass</div>
    <div class="card-body">
      <form (ngSubmit)="onSearch()">
        <div class="input-group">
          <input type="text" class="form-control" placeholder="Enter Visitor Pass Code..." name="passCode" [(ngModel)]="searchPassCode">
          <button class="btn btn-outline-primary" type="submit" [disabled]="!searchPassCode">
            <span *ngIf="isSearching" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            {{ isSearching ? 'Searching...' : 'Search' }}
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Searched Pass Result -->
  <div *ngIf="searchedPass" class="card bg-light mb-4">
    <div class="card-header">
      Search Result for Pass Code: <strong>{{ searchedPass.passCode }}</strong>
    </div>
    <div class="card-body">
      <p><strong>Visitor:</strong> {{ searchedPass.visitorName }}</p>
      <p><strong>Host:</strong> {{ searchedPass.createdByEmployeeName }}</p>
      <p><strong>Status:</strong> <span class="badge" [ngClass]="getStatusClass(searchedPass.status)">{{ searchedPass.status }}</span></p>
      <div>
        <button *ngIf="searchedPass.status === 'APPROVED'" class="btn btn-success me-2" (click)="checkIn(searchedPass.id)">Check-In</button>
        <button *ngIf="searchedPass.status === 'CHECKED_IN'" class="btn btn-warning" (click)="checkOut(searchedPass.id)">Check-Out</button>
      </div>
    </div>
  </div>

  <hr>

  <!-- Visitor Lists -->
  <div class="row">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <!-- FIX: Use totalElements from the Page object -->
          <h4>Approved for Entry ({{ approvedVisitorsPage?.totalElements || 0 }})</h4>
        </div>
        <div class="card-body">
          <div *ngIf="isLoading; else approvedList">
            <app-loading-spinner></app-loading-spinner>
          </div>
          <ng-template #approvedList>
            <ul class="list-group list-group-flush">
              <!-- FIX: Loop over the .content of the Page object -->
              <li *ngFor="let visitor of approvedVisitorsPage?.content" class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                  <strong>{{ visitor.visitorName }}</strong><br>
                  <small class="text-muted">Pass: {{ visitor.passCode }} | Host: {{ visitor.employeeHostName }}</small>
                </div>
                <button class="btn btn-success btn-sm" (click)="checkIn(visitor.passId)">Check-In</button>
              </li>
              <!-- FIX: Check the .empty property of the Page object -->
              <li *ngIf="!isLoading && approvedVisitorsPage?.empty" class="list-group-item text-center text-muted">
                No visitors waiting for check-in.
              </li>
            </ul>
            <app-pagination [page]="approvedVisitorsPage" (pageChange)="onApprovedPageChange($event)"></app-pagination>
          </ng-template>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <!-- FIX: Use totalElements from the Page object -->
          <h4>Currently On-Site ({{ checkedInVisitorsPage?.totalElements || 0 }})</h4>
        </div>
        <div class="card-body">
          <div *ngIf="isLoading; else checkedInList">
             <app-loading-spinner></app-loading-spinner>
          </div>
          <ng-template #checkedInList>
            <ul class="list-group list-group-flush">
              <!-- FIX: Loop over the .content of the Page object -->
              <li *ngFor="let visitor of checkedInVisitorsPage?.content" class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                  <strong>{{ visitor.visitorName }}</strong><br>
                  <small class="text-muted">Pass: {{ visitor.passCode }} | Host: {{ visitor.employeeHostName }}</small>
                </div>
                <button class="btn btn-warning btn-sm" (click)="checkOut(visitor.passId)">Check-Out</button>
              </li>
              <!-- FIX: Check the .empty property of the Page object -->
              <li *ngIf="!isLoading && checkedInVisitorsPage?.empty" class="list-group-item text-center text-muted">
                No visitors currently on-site.
              </li>
            </ul>
            <app-pagination [page]="checkedInVisitorsPage" (pageChange)="onOnSitePageChange($event)"></app-pagination>
          </ng-template>
        </div>
      </div>
    </div>
  </div>
</div>
